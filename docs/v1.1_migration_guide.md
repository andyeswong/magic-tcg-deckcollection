# Migration Guide: v1.0 → v1.1

This guide explains how to upgrade your MTG card ability system from v1.0 to v1.1.

## What's New in v1.1?

### 1. **New Counter Types**
- Added: `stun`, `shield`, `vow`, `lore`, `indestructible`, `flying`, `first_strike`
- Use these for cards like Summon: Valefor (stun counters), Collective Effort (shield counters)

### 2. **Dynamic Value System**
- Replaces static `number | "X"` with `DynamicValue` objects
- Enables complex calculations: "X = number of tapped artifacts"
- Examples: Alibou (tapped artifacts), Chain Reaction (creatures on battlefield)

### 3. **Keyword Actions**
- Added structured support for: investigate, explore, discover, adapt, proliferate, support
- Uses `"action": "keyword_action"` with `keywordAction` field
- Example: Tireless Tracker (investigate)

### 4. **Saga Support**
- New `saga` top-level field for Saga enchantments
- Handles chapter-based triggers
- Supports Saga creatures (Summon: Ixion, etc.)

### 5. **Transformation Effects**
- Cards that change permanent types (Cyberdrive Awakener)
- Conditional abilities (Metalcraft, Threshold)
- Uses `transformation` and `conditional` fields

### 6. **Special Mechanics**
- Hideaway, Sunburst, Converge
- Copy effects (Altered Ego)
- Cost modifications (Affinity, Improvise)

---

## Is Migration Required?

**NO** - v1.1 is **fully backward compatible** with v1.0!

- Existing v1.0 JSON will continue to work
- v1.0 cards don't need immediate migration
- Migrate cards individually as you update them

**When to migrate:**
1. Adding new cards with v1.1 features
2. Fixing/improving existing card data
3. Adding cards from your collection that use new mechanics

---

## Migration Steps

### Step 1: Update Database Schema

Run the migration script:

```bash
psql [your-connection-string] -f scripts/008_upgrade_abilities_to_v1.1.sql
```

This script:
- ✅ Allows both v1.0 and v1.1 schema versions
- ✅ Auto-detects v1.1 features and sets version accordingly
- ✅ Non-breaking change - v1.0 data remains valid

### Step 2: Update Your Parsing Tool

Replace the old system prompt with the new one:

**Old:** `docs/systemprompt_textchecker.md` (v1.0)
**New:** `docs/systemprompt_textchecker_v1.1.md` (v1.1)

Update your LLM parser to use the v1.1 system prompt for all new cards.

### Step 3: Migrate Cards (Optional)

You have three options:

#### Option A: Gradual Migration (Recommended)
- Keep existing v1.0 cards as-is
- Parse new cards with v1.1
- Update v1.0 cards only when needed

#### Option B: Batch Re-Parse
- Re-parse all cards using v1.1 system prompt
- Overwrite existing ability data
- Review and verify changes

#### Option C: Manual Migration
- Identify cards that need v1.1 features
- Manually update their JSON
- Set `schema_version` to `"1.1"`

---

## Feature Mapping: v1.0 → v1.1

### Dynamic Values

**v1.0:**
```json
"damage": {
  "amount": "X",
  "multiplier": "number of creatures on battlefield"
}
```

**v1.1:**
```json
"damage": {
  "amount": {
    "type": "dynamic",
    "calculation": "creatures_on_battlefield"
  }
}
```

### Keyword Actions

**v1.0 (Workaround):**
```json
"effect": {
  "action": "custom",
  "customEffect": "investigate"
}
```

**v1.1 (Proper):**
```json
"effect": {
  "action": "keyword_action",
  "keywordAction": "investigate"
}
```

### Sagas

**v1.0 (Not Supported):**
```json
"triggered": [
  {
    "trigger": { "event": "etb" },
    "effect": { "customEffect": "Chapter I effect" }
  }
]
```

**v1.1 (Proper):**
```json
"saga": {
  "type": "saga",
  "maxChapters": 3,
  "chapters": [
    {
      "chapterNumber": [1],
      "effect": { "action": "exile", ... }
    }
  ]
}
```

---

## Cards from Your Collection Requiring v1.1

Based on your card collection, these cards should use v1.1:

### Keyword Actions
- **Tireless Tracker** - Investigate
- **Incubation Druid** - Adapt
- **Path of Discovery** - Explore

### Dynamic Values
- **Alibou, Ancient Witness** - X = tapped artifacts
- **Chain Reaction** - X = creatures on battlefield
- **Sin, Unending Cataclysm** - X = counters removed × 2
- **Empowered Autogenerator** - X = charge counters
- **Hangarback Walker** - Dies with X tokens

### Sagas
- **Summon: Ixion**
- **Summon: Valefor**
- **Summon: Yojimbo**

### Transformation/Conditional
- **Cyberdrive Awakener** - Artifacts become creatures
- **Dispatch** - Metalcraft conditional exile
- **Fight Rigging** - Hideaway + conditional free play

### Sunburst
- **Lux Artillery**
- **Solar Array**
- **Etched Oracle**

### Copy Effects
- **Altered Ego** - Copy with X counters

### Cost Reduction
- **Etherium Sculptor** - Affinity for artifacts
- **Enthusiastic Mechanaut** - Artifact cost reduction
- **Universal Surveillance** - Improvise

---

## Example Migrations

### Example 1: Hardened Scales (No Changes Needed)

This card works identically in v1.0 and v1.1.

**v1.0:**
```json
{
  "version": "1.0",
  "abilities": {
    "replacement": [{
      "type": "replacement",
      "replaces": "counter_placement",
      "modification": {
        "type": "add_to_counters",
        "counters": { "type": "p1p1", "amount": 1 }
      }
    }]
  }
}
```

**v1.1:** Same JSON, just change version:
```json
{
  "version": "1.1",
  ...
}
```

### Example 2: Tireless Tracker (Needs v1.1 Keywords)

**v1.0 (Workaround):**
```json
{
  "version": "1.0",
  "triggered": [{
    "effect": {
      "action": "custom",
      "customEffect": "investigate (create Clue token)"
    }
  }]
}
```

**v1.1 (Proper):**
```json
{
  "version": "1.1",
  "triggered": [{
    "effect": {
      "action": "keyword_action",
      "keywordAction": "investigate"
    }
  }]
}
```

### Example 3: Alibou (Needs v1.1 Dynamic Values)

**v1.0 (Limited):**
```json
{
  "version": "1.0",
  "triggered": [{
    "effect": {
      "action": "deal_damage",
      "damage": {
        "amount": "X",
        "multiplier": "number of tapped artifacts you control"
      }
    }
  }]
}
```

**v1.1 (Full Support):**
```json
{
  "version": "1.1",
  "triggered": [{
    "effect": {
      "action": "deal_damage",
      "damage": {
        "amount": {
          "type": "dynamic",
          "calculation": "tapped_artifacts",
          "restriction": "you control"
        }
      }
    }
  }]
}
```

---

## Testing Your Migration

### 1. Validate JSON Structure

Run validation script (if you have one):
```bash
node scripts/validate-abilities.js
```

Or use online JSON validator with your schema.

### 2. Query Database

Check schema version distribution:
```sql
SELECT schema_version, COUNT(*) as count
FROM card_abilities
GROUP BY schema_version;
```

Find v1.1 cards:
```sql
SELECT c.name, ca.schema_version, ca.parsing_confidence
FROM cards c
JOIN card_abilities ca ON c.id = ca.card_id
WHERE ca.schema_version = '1.1'
ORDER BY ca.parsing_confidence DESC;
```

### 3. Test in Game Engine

Load a few v1.1 cards in your game and verify:
- ✅ Keyword actions work (investigate, adapt, etc.)
- ✅ Dynamic X values calculate correctly
- ✅ Sagas trigger chapters properly
- ✅ Conditional abilities activate correctly

---

## Common Migration Issues

### Issue 1: Parser Generates v1.0 Instead of v1.1

**Cause**: Using old system prompt

**Fix**: Update to `systemprompt_textchecker_v1.1.md`

### Issue 2: Game Engine Doesn't Recognize v1.1 Features

**Cause**: Game engine still expects v1.0 format

**Fix**: Update `lib/game/ability-loader.ts` to handle v1.1:
```typescript
if (abilities.saga) {
  // Handle saga abilities
  executeSagaChapter(gameState, card, abilities.saga)
}

if (effect.action === "keyword_action") {
  // Handle keyword actions
  executeKeywordAction(gameState, effect.keywordAction, ...)
}

if (typeof amount === "object" && amount.type === "dynamic") {
  // Calculate dynamic value
  const calculated = calculateDynamicValue(gameState, amount)
}
```

### Issue 3: Mixed v1.0 and v1.1 Cards

**Not an Issue**: This is expected and supported!

The game engine should handle both:
```typescript
function loadAbilities(card: CardInstance) {
  const abilities = await fetchAbilities(card.id)

  // Works for both v1.0 and v1.1
  if (abilities.version === "1.1") {
    // Use v1.1 features if available
  }

  // Fall back to v1.0 behavior
  return processAbilities(abilities)
}
```

---

## Rollback Plan

If you need to rollback to v1.0:

### 1. Revert Database
```sql
-- Set all cards back to v1.0
UPDATE card_abilities SET schema_version = '1.0';
```

### 2. Revert System Prompt
Use `systemprompt_textchecker.md` instead of v1.1 version

### 3. Remove v1.1 Features
Cards with v1.1-only features will need manual updates:
- Replace `keywordAction` with `customEffect`
- Replace `DynamicValue` with static values or notes
- Remove `saga` structure, use triggered abilities instead

---

## Summary

✅ **v1.1 is backward compatible** - no forced migration
✅ **Gradual adoption** - migrate cards as needed
✅ **Enhanced features** - dynamic values, keyword actions, sagas
✅ **Auto-detection** - database automatically detects v1.1 features
✅ **Improved parsing** - better LLM accuracy with v1.1 prompt

**Recommended approach:**
1. Run database migration script
2. Update to v1.1 system prompt for new cards
3. Migrate high-priority cards from your collection
4. Let the rest migrate naturally over time

Need help? Check:
- `docs/ability-json-standard-v1.1.md` - Full v1.1 specification
- `docs/systemprompt_textchecker_v1.1.md` - LLM parsing guide
- `docs/README_ability_system.md` - System overview
